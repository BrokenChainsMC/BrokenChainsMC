<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Broken Chains MC | Feed</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=Metal+Mania&display=swap');

* { box-sizing:border-box; margin:0; padding:0; font-family:Arial, Helvetica, sans-serif; }

header {
  position: sticky;
  top: 0;
  z-index: 1000;
}

body {
  margin: 0;
  background: url(images/background.webp) no-repeat center center fixed;
  background-size: cover;
  position: relative;
  overflow-x: hidden;
}

body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  z-index: -1;
}

header {
  background: #000;
  padding: 30px 20px 20px;
  text-align: center;
  border-bottom: 2px solid #b30000;
}

header h1 {
  margin: 0;
  letter-spacing: 4px;
  font-family: 'Metal Mania', cursive;
  font-size: 48px;
  text-transform: uppercase;
  color: #ffffff;
}

nav {
  display: flex;
  justify-content: center;
  margin-top: 10px;
}

nav a {
  color: #b30000;
  text-decoration: none;
  font-weight: bold;
}

nav a:hover {
  color: #ffffff;
}

#feed {
  max-width:500px;
  margin:20px auto;
  background: rgba(0,0,0,0.6);
  border-radius: 10px;
}

.video-card { position:relative; overflow:hidden; margin-bottom:15px; }

.poster-header {
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px;
  background:rgba(0,0,0,0.7);
  border-bottom:1px solid #222;
  z-index:2;
  position:relative;
}

.poster-header img {
  width:42px;
  height:42px;
  border-radius:50%;
  border:2px solid darkred;
}

video {
  width:100%;
  max-height:80vh; 
  object-fit:contain;
  background:black;
  cursor:pointer;
  display:block;
}

.controls {
  padding:10px;
  display:flex;
  flex-direction:column;
  gap:10px;
  width:100%;
  position:relative;
  z-index:2;
}

.bio-toggle {
  padding:8px;
  background:#111;
  border:1px solid #222;
  color:darkred;
  text-align:center;
  cursor:pointer;
  font-weight:bold;
  margin-top:5px;
}

.bio {
  max-height:0;
  overflow:hidden;
  background:rgba(0,0,0,0.85);
  color:#ccc;
  border-top:1px solid #222;
  transition: max-height 0.5s ease;
  border-radius:4px 4px 0 0;
}

.bio-content { padding:10px; white-space: pre-line; }

.side-buttons { 
  position:absolute; 
  right:10px; 
  top:50%; 
  transform:translateY(-50%); 
  display:flex; 
  flex-direction:column; 
  gap:20px; 
  z-index:20; 
}

.side-buttons button { 
  background:none; 
  border:none; 
  color:#fff; 
  font-size:32px; 
  cursor:pointer; 
  text-shadow:0 0 5px #000; 
  display:flex; 
  flex-direction:column; 
  align-items:center; 
}

.side-buttons button.liked { color: #ff3333; }

.side-buttons span { 
  font-size:14px; 
  color:#fff; 
  margin-top:2px; 
  text-shadow:0 0 5px #000; 
}

.comment-overlay {
  position:absolute;
  left:0;
  width:100%;
  height:70%;
  bottom:0;
  background:#fff;
  z-index:50;
  display:none;
  flex-direction:column;
  overflow:hidden;
  border-radius:10px 10px 0 0;
}

.comment-list {
  flex:1;
  overflow-y:auto;
  padding:10px;
  display:flex;
  flex-direction:column;
  gap:5px;
}

.comment-item {
  background:#f0f0f0;
  padding:6px 10px;
  border-radius:8px;
  display:flex;
  flex-direction:column;
  color:#000;
}

.comment-item .meta-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2px;
}

.comment-item .username { font-weight:bold; font-size:12px; color:grey; }
.comment-item .timestamp { font-size: 10px; color: #888; }

.comment-item button { 
  background:none; 
  border:none; 
  color:darkred; 
  cursor:pointer; 
  align-self:flex-end; 
  font-size:14px; 
  opacity:0; 
  transition: opacity 0.2s; 
}

.comment-item:hover button { opacity:1; }

.comment-input {
  display:flex;
  padding:5px;
  border-top:1px solid #ccc;
  gap:5px;
  background:#eee;
}

.comment-input input { flex:1; padding:8px; border:1px solid #ccc; }
.comment-input button { padding:8px; background:darkred; border:none; color:white; cursor:pointer; }
</style>
</head>

<body>

<header>
  <h1>Broken Chains Motorcycle Club</h1>
  <nav>
    <div align="center">
      <a href="index.html">Home</a>
    </div>
  </nav>
</header>

<div id="feed"></div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCgaFQ7EZiKB1LQYbtxwWJ8FkwfRd5iI60",
  authDomain: "brokenchainsmc-f14e5.firebaseapp.com",
  projectId: "brokenchainsmc-f14e5",
  storageBucket: "brokenchainsmc-f14e5.firebasestorage.app",
  messagingSenderId: "30166542756",
  appId: "1:30166542756:web:9797ba4dab1e7689c5f931"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let currentUserUid = null;

firebase.auth().onAuthStateChanged((user) => {
    if (user) {
        currentUserUid = user.uid;
        syncFirebaseData();
    } else {
        firebase.auth().signInAnonymously().catch((error) => {
            console.error("Authentication Error:", error);
        });
    }
});

const videos = [
  { id:1, video_url:"videos/v1.mp4", likes:0, likedBy: [], comments:[] },
  { id:2, video_url:"videos/v2.mp4", likes:0, likedBy: [], comments:[] },
  { id:3, video_url:"videos/v3.mp4", likes:0, likedBy: [], comments:[] },
  { id:4, video_url:"videos/v4.mp4", likes:0, likedBy: [], comments:[] },
  { id:5, video_url:"videos/v5.mp4", likes:0, likedBy: [], comments:[] },
  { id:6, video_url:"videos/v6.mp4", likes:0, likedBy: [], comments:[] },
  { id:7, video_url:"videos/v7.mp4", likes:0, likedBy: [], comments:[] },
];

function renderFeed() {
  const feed = document.getElementById('feed');
  feed.innerHTML = '';

  videos.forEach(video => {
    const div = document.createElement('div');
    div.className='video-card';
    const isLiked = video.likedBy.includes(currentUserUid) ? 'liked' : '';

    div.innerHTML = `
      <div class="poster-header">
        <img src="images/logo.png">
        <div><strong style="color:white">Broken Chains MC</strong></div>
      </div>
      <div class="video-wrapper" style="position:relative;">
        <video id="video-${video.id}" src="${video.video_url}" playsinline loop></video>

        <div class="side-buttons" data-video="${video.id}">
          <button class="${isLiked}" onclick="likeVideo(${video.id})">ğŸ”¥<span>${video.likes}</span></button>
          <button onclick="togglePanel(${video.id},'comments')">ğŸ’¬<span>${video.comments.length}</span></button>
        </div>

        <div class="comment-overlay" id="overlay-${video.id}">
          <div class="comment-list"></div>
          <div class="comment-input">
            <input id="comment-input-${video.id}" placeholder="Add a comment">
            <button onclick="postComment(${video.id})">Post</button>
          </div>
        </div>
      </div>

      <div class="controls">
        <button class="bio-toggle" onclick="togglePanel(${video.id},'bio')">â›“ï¸ Tag List</button>
        <div class="bio" id="bio-${video.id}">
          <div class="bio-content">
â«˜â«˜â«˜â«˜â«˜â«˜â«˜
ğŸ’ğŸ”ğŒğ‚  ğğ‘ğğŠğ„ğ ğ‚ğ‡ğ€ğˆğğ’ ğ‡ğ„ğˆğ‘ğ€ğ‚ğ‡ğ˜
ğ…ğğ‘ ğŒğğ‘ğ„ ğ‚ğğğ“ğ„ğğ“ ğ…ğğ‹ğ‹ğğ–
ğ•€â„•ğ•Šğ•‹ğ”¸ğ”¾â„ğ”¸ğ•„ @46broken_chains_mc
ğ•‹ğ•€ğ•‚ ğ•‹ğ•†ğ•‚ 46brokenchainsmc
â«˜â«˜â«˜â«˜â«˜â«˜â«˜
ğğ«ğğ¬ğ¢ğğğ§ğ­ @chainedxdisciple
ğ•ğ¢ğœğ ğğ«ğğ¬ğ¢ğğğ§ğ­ @chainedxobey
â«˜â«˜â«˜â«˜â«˜â«˜â«˜
          </div>
        </div>
      </div>
    `;
    feed.appendChild(div);

    const vidElement = document.getElementById(`video-${video.id}`);
    vidElement.addEventListener('click', () => {
        if(vidElement.paused) {
            vidElement.play();
            vidElement.muted = false; // Ensure sound is on when clicked
        } else {
            vidElement.pause();
        }
    });
  });
  
  setupAutoPlay();
}

async function syncFirebaseData() {
    for (const v of videos) {
        const docRef = db.collection('videos').doc(String(v.id));
        const doc = await docRef.get();
        if(doc.exists){
            const data = doc.data();
            v.likes = data.likes || 0;
            v.likedBy = data.likedBy || [];
            v.comments = data.comments || [];
        } else {
            await docRef.set({likes:0, likedBy: [], comments:[]});
        }
    }
    updateInteractionCounts();
}

function updateInteractionCounts() {
    videos.forEach(v => {
        const sideBtns = document.querySelector(`.side-buttons[data-video="${v.id}"]`);
        if(sideBtns) {
            sideBtns.querySelector('button:first-child span').textContent = v.likes;
            sideBtns.querySelector('button:nth-child(2) span').textContent = v.comments.length;
            if(v.likedBy.includes(currentUserUid)) {
                sideBtns.querySelector('button:first-child').classList.add('liked');
            }
        }
    });
}

function togglePanel(id, type) {
  const bio = document.getElementById(`bio-${id}`);
  const overlay = document.getElementById(`overlay-${id}`);
  if(type==='bio') {
    bio.style.maxHeight = bio.style.maxHeight==='0px'||bio.style.maxHeight==='' ? bio.scrollHeight+'px' : '0';
  }
  if(type==='comments') {
    renderOverlayComments(id);
    overlay.style.display = 'flex';
  }
}

async function likeVideo(id) {
    if (!currentUserUid) return;
    const video = videos.find(v => v.id === id);
    if (!video) return;

    const userIndex = video.likedBy.indexOf(currentUserUid);
    if (userIndex > -1) {
        video.likedBy.splice(userIndex, 1);
    } else {
        video.likedBy.push(currentUserUid);
    }

    video.likes = video.likedBy.length;
    await db.collection('videos').doc(String(id)).update({
        likes: video.likes,
        likedBy: video.likedBy
    });

    const likeBtn = document.querySelector(`.side-buttons[data-video="${id}"] button:first-child`);
    likeBtn.querySelector('span').textContent = video.likes;
    video.likedBy.includes(currentUserUid) ? likeBtn.classList.add('liked') : likeBtn.classList.remove('liked');
}

async function postComment(id) {
  const input = document.getElementById(`comment-input-${id}`);
  const text = input.value.trim();
  if(!text) return;
  
  const video = videos.find(v => v.id === id);
  const newComment = { text: text, uid: currentUserUid, timestamp: Date.now() };

  video.comments.push(newComment);
  await db.collection('videos').doc(String(id)).update({comments: video.comments});

  input.value = "";
  renderOverlayComments(id);
  updateInteractionCounts();
}

function renderOverlayComments(videoId) {
  const overlay = document.getElementById(`overlay-${videoId}`);
  const list = overlay.querySelector('.comment-list');
  list.innerHTML = '';
  const video = videos.find(v => v.id === videoId);

  video.comments.forEach((c, i) => {
    const div = document.createElement('div');
    div.className='comment-item';
    const timeString = new Date(c.timestamp).toLocaleString([], { dateStyle: 'short', timeStyle: 'short' });

    div.innerHTML = `
      <div class="meta-row"><span class="username">Member</span><span class="timestamp">${timeString}</span></div>
      <div>${c.text}</div>
      ${c.uid === currentUserUid ? `<button onclick="deleteComment(${videoId}, ${i})">âŒ</button>` : ''}
    `;
    list.appendChild(div);
  });

  const input = document.getElementById(`comment-input-${videoId}`);
  input.onkeydown = e => { if(e.key==='Enter') postComment(videoId); };
}

async function deleteComment(videoId, index) {
  const video = videos.find(v => v.id === videoId);
  if(video.comments[index].uid !== currentUserUid) return;
  video.comments.splice(index, 1);
  await db.collection('videos').doc(String(videoId)).update({comments: video.comments});
  renderOverlayComments(videoId);
  updateInteractionCounts();
}

function setupAutoPlay() {
  const allVids = document.querySelectorAll('video');
  const playCenteredVideo = () => {
    const viewportCenter = window.innerHeight / 2;
    let closestVideo = null;
    let closestDistance = Infinity;

    allVids.forEach(v => {
      const rect = v.getBoundingClientRect();
      const videoCenter = rect.top + rect.height / 2;
      const distance = Math.abs(viewportCenter - videoCenter);
      if(distance < closestDistance) {
        closestDistance = distance;
        closestVideo = v;
      }
    });

    allVids.forEach(v => {
      if(v === closestVideo) {
          // Note: Most browsers will block v.play() with audio unless the user has interacted with the site first.
          v.play().catch(() => {
              v.muted = true; // Fallback to muted autoplay if audio is blocked
              v.play();
          });
      } else {
          v.pause();
      }
    });
  };

  window.addEventListener('scroll', playCenteredVideo);
  window.addEventListener('resize', playCenteredVideo);
}

document.addEventListener('click', e => {
  videos.forEach(v => {
    const overlay = document.getElementById(`overlay-${v.id}`);
    if (overlay && overlay.style.display === 'flex' && !overlay.contains(e.target) && !e.target.closest('.side-buttons button')) {
      overlay.style.display = 'none';
    }
  });
});

renderFeed();
</script>
</body>
</html>
