<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Broken Chains MC | Feed</title>
<style>
* { box-sizing:border-box; margin:0; padding:0; font-family:Arial, Helvetica, sans-serif; }

body {
  margin: 0;
  background: url(images/background.webp) no-repeat center center fixed;
  background-size: cover;
  position: relative;
  overflow-x: hidden;
}

body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  z-index: -1;
}

#feed {
  max-width:500px;
  margin:auto;
  background: rgba(0,0,0,0.6);
  border-radius: 10px;
}

.video-card { position:relative; overflow:hidden; margin-bottom:15px; }

.poster-header {
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px;
  background:rgba(0,0,0,0.7);
  border-bottom:1px solid #222;
  z-index:2;
  position:relative;
}

.poster-header img {
  width:42px;
  height:42px;
  border-radius:50%;
  border:2px solid darkred;
}

video {
  width:100%;
  max-height:80vh; 
  object-fit:contain;
  background:black;
  cursor:pointer;
  display:block;
}

.controls {
  padding:10px;
  display:flex;
  flex-direction:column;
  gap:10px;
  width:100%;
  position:relative;
  z-index:2;
}

.bio-toggle {
  padding:8px;
  background:#111;
  border:1px solid #222;
  color:darkred;
  text-align:center;
  cursor:pointer;
  font-weight:bold;
  margin-top:5px;
}

.bio {
  max-height:0;
  overflow:hidden;
  background:rgba(0,0,0,0.85);
  color:#ccc;
  border-top:1px solid #222;
  transition: max-height 0.5s ease;
  border-radius:4px 4px 0 0;
}

.bio-content { padding:10px; white-space: pre-line; }

.side-buttons { 
  position:absolute; 
  right:10px; 
  top:50%; 
  transform:translateY(-50%); 
  display:flex; 
  flex-direction:column; 
  gap:20px; 
  z-index:20; 
}

.side-buttons button { 
  background:none; 
  border:none; 
  color:#fff; 
  font-size:32px; 
  cursor:pointer; 
  text-shadow:0 0 5px #000; 
  display:flex; 
  flex-direction:column; 
  align-items:center; 
}

.side-buttons span { 
  font-size:14px; 
  color:#fff; 
  margin-top:2px; 
  text-shadow:0 0 5px #000; 
}

.comment-overlay {
  position:absolute;
  left:0;
  width:100%;
  height:70%;
  bottom:0;
  background:#fff;
  z-index:50;
  display:none;
  flex-direction:column;
  overflow:hidden;
  border-radius:10px 10px 0 0;
}

.comment-list {
  flex:1;
  overflow-y:auto;
  padding:10px;
  display:flex;
  flex-direction:column;
  gap:5px;
}

.comment-item {
  background:#f0f0f0;
  padding:6px 10px;
  border-radius:8px;
  display:flex;
  flex-direction:column;
  color:#000;
}

.comment-item .username { 
  font-weight:bold; 
  font-size:12px; 
  margin-bottom:2px; 
  color:grey; 
}

.comment-item button { 
  background:none; 
  border:none; 
  color:darkred; 
  cursor:pointer; 
  align-self:flex-end; 
  font-size:14px; 
  opacity:0; 
  transition: opacity 0.2s; 
}

.comment-item:hover button { opacity:1; }

.comment-input {
  display:flex;
  padding:5px;
  border-top:1px solid #ccc;
  gap:5px;
  background:#eee;
}

.comment-input input {
  flex:1;
  padding:8px;
  border:1px solid #ccc;
}

.comment-input button {
  padding:8px;
  background:darkred;
  border:none;
  color:white;
  cursor:pointer;
}
</style>
</head>
<body>

<div id="feed"></div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCgaFQ7EZiKB1LQYbtxwWJ8FkwfRd5iI60",
  authDomain: "brokenchainsmc-f14e5.firebaseapp.com",
  projectId: "brokenchainsmc-f14e5",
  storageBucket: "brokenchainsmc-f14e5.firebasestorage.app",
  messagingSenderId: "30166542756",
  appId: "1:30166542756:web:9797ba4dab1e7689c5f931"
};

firebase.initializeApp(firebaseConfig);
firebase.auth().signInAnonymously();
const db = firebase.firestore();

const videos = [
  { id:0, video_url:"videos/v1.mp4", docId:"v1", likes: 0, comments: [] },
  { id:1, video_url:"videos/v2.mp4", docId:"v2", likes: 0, comments: [] },
  { id:2, video_url:"videos/v3.mp4", docId:"v3", likes: 0, comments: [] },
  { id:3, video_url:"videos/v4.mp4", docId:"v4", likes: 0, comments: [] },
  { id:4, video_url:"videos/v5.mp4", docId:"v5", likes: 0, comments: [] },
  { id:5, video_url:"videos/v6.mp4", docId:"v6", likes: 0, comments: [] },
  { id:6, video_url:"videos/v7.mp4", docId:"v7", likes: 0, comments: [] }
];

// -------------------- Core Functions --------------------

function togglePanel(id,type){
  const bio = document.getElementById(`bio-${id}`);
  const overlay = document.getElementById(`overlay-${id}`);
  if(type==='bio'){
    bio.style.maxHeight = bio.style.maxHeight==='0px'||bio.style.maxHeight==='' ? bio.scrollHeight+'px' : '0';
  }
  if(type==='comments'){
    renderOverlay(id);
    overlay.style.display = 'flex';
  }
}

function togglePlay(video){
  if(video.paused) video.play();
  else video.pause();
}

// -------------------- Firestore Functions --------------------

async function fetchVideoData(video) {
  const docRef = db.collection("videos").doc(video.docId);
  const docSnap = await docRef.get();
  if(docSnap.exists){
    return docSnap.data();
  } else {
    // Initialize doc if it doesn't exist
    await docRef.set({ likes: 0, comments: [] });
    return { likes:0, comments:[] };
  }
}

async function updateLikes(video) {
  const docRef = db.collection("videos").doc(video.docId);
  const data = await fetchVideoData(video);
  await docRef.update({ likes: data.likes });
  return data.likes;
}

async function likeVideo(id){
  const video = videos.find(v=>v.id===id);
  if(!video) return;

  const docRef = db.collection("videos").doc(video.docId);
  const docSnap = await docRef.get();
  let data = docSnap.data() || {likes:0, comments:[]};

  const likedKey = `liked-${video.id}`;
  if(localStorage.getItem(likedKey)){
    data.likes--;
    localStorage.removeItem(likedKey);
  } else {
    data.likes++;
    localStorage.setItem(likedKey,'true');
  }

  await docRef.update({ likes: data.likes });

  // Update UI
  const likeBtn = document.querySelector(`.side-buttons[data-video="${id}"] button:first-child span`);
  if(likeBtn) likeBtn.textContent = data.likes;
}

async function postComment(id){
  const input = document.getElementById(`comment-input-${id}`);
  if(!input.value) return;
  const video = videos.find(v=>v.id===id);
  const docRef = db.collection("videos").doc(video.docId);

  const docSnap = await docRef.get();
  let data = docSnap.data() || {likes:0, comments:[]};
  data.comments.push({text: input.value, user:"Anonymous"});

  await docRef.update({ comments: data.comments });
  input.value = "";
  renderOverlay(id);
}

async function renderOverlay(videoId){
  const overlay = document.getElementById(`overlay-${videoId}`);
  const list = overlay.querySelector('.comment-list');
  list.innerHTML = '';
  const video = videos.find(v=>v.id===videoId);
  const docRef = db.collection("videos").doc(video.docId);
  const docSnap = await docRef.get();
  const data = docSnap.data() || {likes:0, comments:[]};

  data.comments.forEach((c,i)=>{
    const div = document.createElement('div');
    div.className='comment-item';
    div.innerHTML = `
      <div class="username">Anonymous</div>
      ${c.text}
      <button data-video="${videoId}" data-index="${i}">âŒ</button>
    `;
    list.appendChild(div);
  });

  overlay.querySelectorAll('.comment-item button').forEach(btn=>{
    btn.addEventListener('click', async e=>{
      e.stopPropagation();
      data.comments.splice(Number(btn.dataset.index),1);
      await db.collection("videos").doc(video.docId).update({ comments: data.comments });
      renderOverlay(videoId);
    });
  });

  const input = document.getElementById(`comment-input-${videoId}`);
  input.onkeydown = e => { if(e.key==='Enter') postComment(videoId); };

  // Update comment counter
  const btnCounter = document.querySelector(`.side-buttons[data-video="${videoId}"] button:nth-child(2) span`);
  if(btnCounter) btnCounter.textContent = data.comments.length;

  // Update likes counter
  const likeCounter = document.querySelector(`.side-buttons[data-video="${videoId}"] button:first-child span`);
  if(likeCounter) likeCounter.textContent = data.likes;
}

// -------------------- Render Feed --------------------

async function renderFeed(){
  const feed = document.getElementById('feed');
  feed.innerHTML = '';

  for(const video of videos){
    const docData = await fetchVideoData(video);
    const div = document.createElement('div');
    div.className='video-card';
    div.innerHTML = `
      <div class="poster-header">
        <img src="images/logo.png">
        <div><strong style="color:white">Broken Chains MC</strong></div>
      </div>
      <div class="video-wrapper" style="position:relative;">
        <video id="video-${video.id}" src="${video.video_url}" autoplay playsinline></video>

        <div class="side-buttons" data-video="${video.id}">
          <button onclick="likeVideo(${video.id})">ğŸ”¥<span>${docData.likes}</span></button>
          <button onclick="togglePanel(${video.id},'comments')">ğŸ’¬<span>${docData.comments.length}</span></button>
        </div>

        <div class="comment-overlay" id="overlay-${video.id}">
          <div class="comment-list"></div>
          <div class="comment-input">
            <input id="comment-input-${video.id}" placeholder="Add a comment">
            <button onclick="postComment(${video.id})">Post</button>
          </div>
        </div>
      </div>

      <div class="controls">
        <button class="bio-toggle" onclick="togglePanel(${video.id},'bio')">â›“ï¸ Tag List</button>
        <div class="bio" id="bio-${video.id}">
          <div class="bio-content">
â«˜â«˜â«˜â«˜â«˜â«˜â«˜
ğŸ’ğŸ”ğŒğ‚  ğğ‘ğğŠğ„ğ ğ‚ğ‡ğ€ğˆğğ’ ğ‡ğ„ğˆğ‘ğ€ğ‚ğ‡ğ˜
...
          </div>
        </div>
      </div>
    `;
    feed.appendChild(div);

    const vid = document.getElementById(`video-${video.id}`);
    vid.addEventListener('click', ()=>togglePlay(vid));
  }

  // Play only the video closest to center
  const allVideos = document.querySelectorAll('video');
  function playCenteredVideo() {
    const viewportCenter = window.innerHeight / 2;
    let closestVideo = null;
    let closestDistance = Infinity;

    allVideos.forEach(v => {
      const rect = v.getBoundingClientRect();
      const videoCenter = rect.top + rect.height / 2;
      const distance = Math.abs(viewportCenter - videoCenter);
      if(distance < closestDistance){
        closestDistance = distance;
        closestVideo = v;
      }
    });

    allVideos.forEach(v => {
      if(v === closestVideo) v.play().catch(()=>{});
      else v.pause();
    });
  }

  window.addEventListener('scroll', playCenteredVideo);
  window.addEventListener('resize', playCenteredVideo);
  window.addEventListener('load', playCenteredVideo);
}

// -------------------- Close Comments When Clicking Outside --------------------

document.addEventListener('click', e => {
  videos.forEach(v => {
    const overlay = document.getElementById(`overlay-${v.id}`);
    if (overlay.style.display === 'flex' && !overlay.contains(e.target) && !e.target.closest('.side-buttons button')) {
      overlay.style.display = 'none';
    }
  });
});
document.addEventListener('touchstart', e => {
  videos.forEach(v => {
    const overlay = document.getElementById(`overlay-${v.id}`);
    if (overlay.style.display === 'flex' && !overlay.contains(e.target) && !e.target.closest('.side-buttons button')) {
      overlay.style.display = 'none';
    }
  });
});

// -------------------- Initialize --------------------

renderFeed();
</script>
</body>
</html>


