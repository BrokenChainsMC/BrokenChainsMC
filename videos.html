<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Broken Chains MC | Feed</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=Metal+Mania&display=swap');

* { box-sizing:border-box; margin:0; padding:0; font-family:Arial, Helvetica, sans-serif; }

header {
  position: sticky;
  top: 0;
  z-index: 1000;
}

body {
  margin: 0;
  background: url(images/background.webp) no-repeat center center fixed;
  background-size: cover;
  position: relative;
  overflow-x: hidden;
}

body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  z-index: -1;
}

/* ===== HEADER ===== */
header {
  background: #000;
  padding: 30px 20px 20px;
  text-align: center;
  border-bottom: 2px solid #b30000;
}

header h1 {
  margin: 0;
  letter-spacing: 4px;
  font-family: 'Metal Mania', cursive;
  font-size: 48px;
  text-transform: uppercase;
  color: #ffffff;
}

nav {
  display: flex;
  justify-content: center;
  margin-top: 10px;
}

nav a {
  color: #b30000;
  text-decoration: none;
  font-weight: bold;
}

nav a:hover {
  color: #ffffff;
}

#feed {
  max-width:500px;
  margin:20px auto;
  background: rgba(0,0,0,0.6);
  border-radius: 10px;
}

.video-card { position:relative; overflow:hidden; margin-bottom:15px; }

.poster-header {
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px;
  background:rgba(0,0,0,0.7);
  border-bottom:1px solid #222;
  z-index:2;
  position:relative;
}

.poster-header img {
  width:42px;
  height:42px;
  border-radius:50%;
  border:2px solid darkred;
}

.video-wrapper {
  position: relative;
  width: 100%;
}

video {
  width:100%;
  max-height:80vh; 
  object-fit:contain;
  background:black;
  cursor:pointer;
  display:block;
}

.controls {
  padding:10px;
  display:flex;
  flex-direction:column;
  gap:10px;
  width:100%;
  position:relative;
  z-index:2;
}

.bio-toggle {
  padding:8px;
  background:#111;
  border:1px solid #222;
  color:darkred;
  text-align:center;
  cursor:pointer;
  font-weight:bold;
  margin-top:5px;
}

.bio {
  max-height:0;
  overflow:hidden;
  background:rgba(0,0,0,0.85);
  color:#ccc;
  border-top:1px solid #222;
  transition: max-height 0.5s ease;
  border-radius:4px 4px 0 0;
}

.bio-content { padding:10px; white-space: pre-line; }

.side-buttons { 
  position:absolute; 
  right:10px; 
  top:50%; 
  transform:translateY(-50%); 
  display:flex; 
  flex-direction:column; 
  gap:20px; 
  z-index: 100; 
}

.side-buttons button { 
  background:none; 
  border:none; 
  color:#fff; 
  font-size:32px; 
  cursor:pointer; 
  text-shadow:0 0 5px #000; 
  display:flex; 
  flex-direction:column; 
  align-items:center; 
  transition: transform 0.1s;
}

.side-buttons button:active {
  transform: scale(0.9);
}

.side-buttons button.liked {
  color: #ff4444; 
}

.side-buttons span { 
  font-size:14px; 
  color:#fff; 
  margin-top:2px; 
  text-shadow:0 0 5px #000; 
}

/* Comment Styles */
/* Z-Index 200 ensures it is ON TOP of the side buttons (which are 100) */
.comment-overlay {
  position:absolute;
  left:0;
  width:100%;
  height:70%;
  bottom:0;
  background:#fff;
  z-index:200; 
  display:none; 
  flex-direction:column;
  overflow:hidden;
  border-radius:10px 10px 0 0;
  box-shadow: 0 -5px 15px rgba(0,0,0,0.5);
}

.click-mask {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 30%; 
  z-index: 49; 
  display: none;
  background: transparent;
}

.comment-list {
  flex:1;
  overflow-y:auto;
  padding:10px;
  display:flex;
  flex-direction:column;
  gap:5px;
}

.comment-item {
  background:#f0f0f0;
  padding:6px 10px;
  border-radius:8px;
  display:flex;
  flex-direction:column;
  color:#000;
}

.comment-item .username { 
  font-weight:bold; 
  font-size:12px; 
  margin-bottom:2px; 
  color:grey; 
}

.comment-item button { 
  background:none; 
  border:none; 
  color:darkred; 
  cursor:pointer; 
  align-self:flex-end; 
  font-size:14px; 
}

.comment-input {
  display:flex;
  padding:5px;
  border-top:1px solid #ccc;
  gap:5px;
  background:#eee;
}

.comment-input input {
  flex:1;
  padding:8px;
  border:1px solid #ccc;
}

.comment-input button {
  padding:8px;
  background:darkred;
  border:none;
  color:white;
  cursor:pointer;
}

.comment-input button:disabled {
  background: #999;
  cursor: not-allowed;
}
</style>
</head>

<body>

<header>
  <h1>Broken Chains Motorcycle Club</h1>
  <nav>
    <div align="center">
      <a href="index.html">Home</a>
    </div>
  </nav>
</header>

<div id="feed"></div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCgaFQ7EZiKB1LQYbtxwWJ8FkwfRd5iI60",
  authDomain: "brokenchainsmc-f14e5.firebaseapp.com",
  projectId: "brokenchainsmc-f14e5",
  storageBucket: "brokenchainsmc-f14e5.firebasestorage.app",
  messagingSenderId: "30166542756",
  appId: "1:30166542756:web:9797ba4dab1e7689c5f931"
};

// Initialize
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

let currentUser = null;

// Handle Auth State
auth.signInAnonymously().catch(e => console.error("Auth Error:", e));

auth.onAuthStateChanged((user) => {
  if (user) {
    currentUser = user;
    console.log("Auth ready:", currentUser.uid);
  }
});

// Using Strings for IDs to prevent number/string mismatch issues
const videos = [
  { id:"1", video_url:"videos/v1.mp4", likes:0, comments:[] },
  { id:"2", video_url:"videos/v2.mp4", likes:0, comments:[] },
  { id:"3", video_url:"videos/v3.mp4", likes:0, comments:[] },
  { id:"4", video_url:"videos/v4.mp4", likes:0, comments:[] },
  { id:"5", video_url:"videos/v5.mp4", likes:0, comments:[] },
  { id:"6", video_url:"videos/v6.mp4", likes:0, comments:[] },
  { id:"7", video_url:"videos/v7.mp4", likes:0, comments:[] },
];

// Ensure each video doc exists and attach realtime listeners
videos.forEach(async v => {
  try {
    const docRef = db.collection('videos').doc(v.id);
    const doc = await docRef.get();
    if(!doc.exists){
      await docRef.set({likes:0, likedBy:[], comments:[]});
    }
    // attach snapshot listener for authoritative updates
    attachVideoSnapshotListener(v.id);
  } catch (err) {
    console.error("Database Error:", err);
  }
});

/* -------------------------
   Like helpers (local state)
   ------------------------- */
function getLikedVideos() {
    try {
        const stored = JSON.parse(localStorage.getItem('brokenchains_likes') || '[]');
        return Array.isArray(stored) ? stored.map(id => String(id)) : [];
    } catch (e) {
        return [];
    }
}

function setLikedVideos(arr) {
    try { localStorage.setItem('brokenchains_likes', JSON.stringify(arr)); } catch(e){}
}

function updateLikeButtonUI(id) {
    const strId = String(id);
    const likedVideos = getLikedVideos();
    const container = document.querySelector(`.side-buttons[data-video="${strId}"]`);
    if(!container) return;
    const btn = container.querySelector('button:first-child');
    const span = btn.querySelector('span');
    const video = videos.find(v=>v.id===strId);
    if(span && video) span.textContent = video.likes;
    if(likedVideos.includes(strId)) btn.classList.add('liked'); else btn.classList.remove('liked');
}

/* -------------------------
   Listen for Firestore changes
   authoritative counts come from here
   ------------------------- */
function attachVideoSnapshotListener(id){
  const strId = String(id);
  const ref = db.collection('videos').doc(strId);

  ref.onSnapshot(doc => {
    if(!doc.exists) return;
    const data = doc.data();
    const v = videos.find(x => x.id === strId);
    if(!v) return;
    // Prefer authoritative likedBy length if present
    if(Array.isArray(data.likedBy)) {
      v.likes = data.likedBy.length;
    } else if (typeof data.likes === 'number') {
      v.likes = data.likes;
    } else {
      v.likes = v.likes || 0;
    }
    v.comments = Array.isArray(data.comments) ? data.comments : (v.comments || []);
    // update UI after authoritative change
    updateLikeButtonUI(strId);
    updateCommentCount(strId);
    console.log(`snapshot ${strId}: likes=${v.likes}, comments=${v.comments.length}`);
  });
}

/* -------------------------
   Robust like/unlike using arrayUnion/arrayRemove + increment
   - fallback to sign-in if needed
   - optimistic UI, revert on failure
   ------------------------- */
async function likeVideo(id){
  const strId = String(id);
  // ensure we have an auth user; if not, try to sign in now
  if(!currentUser){
    try {
      await auth.signInAnonymously();
      currentUser = auth.currentUser;
    } catch(e){
      console.error("Auth failed on like attempt", e);
      alert("Unable to like right now â€” auth failed.");
      return;
    }
  }
  const uid = currentUser.uid;
  const ref = db.collection('videos').doc(strId);

  const localLiked = getLikedVideos();
  const wasLikedLocally = localLiked.includes(strId);

  // optimistic toggle local state & UI
  let newLocal;
  if(wasLikedLocally){
    newLocal = localLiked.filter(x=>x!==strId);
  } else {
    newLocal = [...localLiked, strId];
  }
  setLikedVideos(newLocal);
  updateLikeButtonUI(strId);

  // build server update payload
  try {
    if(wasLikedLocally){
      // UNLIKE
      await ref.set({
        likedBy: firebase.firestore.FieldValue.arrayRemove(uid),
        likes: firebase.firestore.FieldValue.increment(-1)
      }, { merge: true });
    } else {
      // LIKE
      await ref.set({
        likedBy: firebase.firestore.FieldValue.arrayUnion(uid),
        likes: firebase.firestore.FieldValue.increment(1)
      }, { merge: true });
    }
    // success -> snapshot listener will update authoritative count and we keep localStorage
    console.log(`likeVideo: server updated ${strId} (wasLikedLocally=${wasLikedLocally})`);
  } catch (e) {
    console.error("likeVideo server update failed", e);
    // revert local optimistic change
    try {
      const snap = await ref.get();
      if(snap.exists && Array.isArray(snap.data().likedBy)){
        const serverHas = snap.data().likedBy.map(String).includes(uid);
        // align local to server
        let aligned = getLikedVideos();
        if(serverHas && !aligned.includes(strId)) aligned.push(strId);
        if(!serverHas) aligned = aligned.filter(x=>x!==strId);
        setLikedVideos(aligned);
      } else {
        // if server data missing, remove local like for safety
        setLikedVideos(getLikedVideos().filter(x=>x!==strId));
      }
    } catch(_) {
      setLikedVideos(getLikedVideos().filter(x=>x!==strId));
    }
    updateLikeButtonUI(strId);
  }
}

/* -------------------------
   Comment / UI functions (unchanged behavior)
   ------------------------- */
async function postComment(id){
  const strId = String(id);
  if (!currentUser) {
      alert("Still connecting to network... please try again in a moment.");
      return;
  }

  const input = document.getElementById(`comment-input-${strId}`);
  const text = input.value.trim();
  if(!text) return;

  const video = videos.find(v=>v.id===strId);

  const newComment = {
    text: text,
    uid: currentUser.uid,
    timestamp: Date.now()
  };

  try {
      video.comments.push(newComment);
      input.value = "";

      await db.collection('videos').doc(strId).update({comments: video.comments});

      renderOverlay(strId);
      updateCommentCount(strId);
  } catch (e) {
      console.error("Post Error", e);
  }
}

function updateCommentCount(id){
  const strId = String(id);
  const btn = document.querySelector(`.side-buttons[data-video="${strId}"] button:nth-child(2) span`);
  const video = videos.find(v=>v.id===strId);
  if(btn && video) btn.textContent = video.comments.length;
}

async function deleteComment(videoId, index){
  const strId = String(videoId);
  const video = videos.find(v=>v.id===strId);
  if(!video) return;

  try {
      if(!video.comments[index] || video.comments[index].uid !== currentUser.uid) return;
      video.comments.splice(index,1);
      await db.collection('videos').doc(strId).update({comments: video.comments});
      renderOverlay(strId);
      updateCommentCount(strId);
  } catch(e) {
      console.error("Delete Error", e);
  }
}

function togglePlay(video){
  if(video.paused) video.play();
  else video.pause();
}

function renderOverlay(videoId){
  const strId = String(videoId);
  const overlay = document.getElementById(`overlay-${strId}`);
  const list = overlay.querySelector('.comment-list');
  list.innerHTML = '';
  const video = videos.find(v=>v.id===strId);

  if(video.comments.length === 0) {
      list.innerHTML = '<div style="color:#aaa; text-align:center; padding:20px;">No comments yet.</div>';
  }

  video.comments.forEach((c,i)=>{
    const div = document.createElement('div');
    div.className='comment-item';

    let deleteBtn = '';
    if (currentUser && c.uid === currentUser.uid) {
        deleteBtn = `<button onclick="deleteComment('${strId}', ${i})">âŒ</button>`;
    }

    div.innerHTML = `
      <div class="username">Anonymous Rider</div>
      <div>${c.text}</div>
      ${deleteBtn}
    `;
    list.appendChild(div);
  });
}

function togglePanel(id, type){
  const strId = String(id);
  const bio = document.getElementById(`bio-${strId}`);
  const overlay = document.getElementById(`overlay-${strId}`);
  const mask = document.getElementById(`click-mask-${strId}`);

  if(type === 'bio'){
    bio.style.maxHeight = bio.style.maxHeight==='0px'||bio.style.maxHeight==='' ? bio.scrollHeight+'px' : '0';
  }

  if(type === 'comments'){
    const isHidden = overlay.style.display === 'none' || overlay.style.display === '';
    if (isHidden) {
      renderOverlay(strId);
      overlay.style.display = 'flex';
      mask.style.display = 'block';
    } else {
      closeComments(strId);
    }
  }
}

function closeComments(id) {
    const strId = String(id);
    const overlay = document.getElementById(`overlay-${strId}`);
    const mask = document.getElementById(`click-mask-${strId}`);
    if(overlay) overlay.style.display = 'none';
    if(mask) mask.style.display = 'none';
}

function renderFeed(){
  const feed = document.getElementById('feed');
  feed.innerHTML = '';

  videos.forEach(video=>{
    const div = document.createElement('div');
    div.className='video-card';

    div.innerHTML = `
      <div class="poster-header">
        <img src="images/logo.png">
        <div><strong style="color:white">Broken Chains MC</strong></div>
      </div>
      <div class="video-wrapper">
        <video id="video-${video.id}" src="${video.video_url}" autoplay playsinline loop></video>

        <div id="click-mask-${video.id}" class="click-mask" onclick="closeComments('${video.id}')"></div>

        <div class="side-buttons" data-video="${video.id}">
          <button onclick="likeVideo('${video.id}')">ğŸ”¥<span>${video.likes}</span></button>
          <button onclick="togglePanel('${video.id}','comments')">ğŸ’¬<span>${video.comments.length}</span></button>
        </div>

        <div class="comment-overlay" id="overlay-${video.id}">
          <div class="comment-list"></div>
          <div class="comment-input">
            <input id="comment-input-${video.id}" placeholder="Add a comment..." onkeydown="if(event.key==='Enter') postComment('${video.id}')">
            <button onclick="postComment('${video.id}')">Post</button>
          </div>
        </div>
      </div>

      <div class="controls">
        <button class="bio-toggle" onclick="togglePanel('${video.id}','bio')">â›“ï¸ Tag List</button>
        <div class="bio" id="bio-${video.id}">
          <div class="bio-content">
â«˜â«˜â«˜â«˜â«˜â«˜â«˜
ğŸ’ğŸ”ğŒğ‚  ğğ‘ğğŠğ„ğ ğ‚ğ‡ğ€ğˆğğ’ ğ‡ğ„ğˆğ‘ğ€ğ‚ğ‡ğ˜
ğ…ğğ‘ ğŒğğ‘ğ„ ğ‚ğğğ“ğ„ğğ“ ğ…ğğ‹ğ‹ğğ–

ğ•€â„•ğ•Šğ•‹ğ”¸ğ”¾â„ğ”¸ğ•„ @46broken_chains_mc

ğ•‹ğ•€ğ•‚ ğ•‹ğ•†ğ•‚
46brokenchainsmc
â«˜â«˜â«˜â«˜â«˜â«˜â«˜
          </div>
        </div>
      </div>
    `;
    feed.appendChild(div);

    // ensure UI reflects localStorage like class & DB counts
    updateLikeButtonUI(video.id);
    updateCommentCount(video.id);

    const vid = document.getElementById(`video-${video.id}`);
    vid.addEventListener('click', ()=> togglePlay(vid));
  });

  const allVideos = document.querySelectorAll('video');
  function playCenteredVideo() {
    const viewportCenter = window.innerHeight / 2;
    let closestVideo = null;
    let closestDistance = Infinity;

    allVideos.forEach(v => {
      const rect = v.getBoundingClientRect();
      const videoCenter = rect.top + rect.height / 2;
      const distance = Math.abs(viewportCenter - videoCenter);
      if(distance < closestDistance){
        closestDistance = distance;
        closestVideo = v;
      }
    });

    allVideos.forEach(v => {
      if(v === closestVideo) v.play().catch(()=>{});
      else v.pause();
    });
  }

  window.addEventListener('scroll', playCenteredVideo);
  window.addEventListener('resize', playCenteredVideo);
  window.addEventListener('load', playCenteredVideo);
}

renderFeed();
</script>
</body>
</html>
